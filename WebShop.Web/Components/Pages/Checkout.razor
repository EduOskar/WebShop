@page "/Checkout"
@inject NavigationManager navigationManager
@inject CustomStateProvider authenticationStateProvider

@if (UserInfo == null)
{
    <DisplaySpinner />
}
else
{
    <EditForm class="form-signin md-4" OnValidSubmit="OnSubmit" Model="Command">
        <DataAnnotationsValidator />
        <label for="inputAdressLine" class="sr-only">@UserInfo.Adress</label>
        <InputText id="inputAdressLine" class="form-control" aria-required="true" @bind-Value="Command!.BillingAdress.AddressLine" autofocus placeholder="@UserInfo.Adress" />
        <ValidationMessage For="@(() => Command.BillingAdress.AddressLine)" />

        <label for="inputCity" class="sr-only">City</label>
        <InputText id="inputCity" class="form-control" aria-required="true" @bind-Value="Command.BillingAdress.City" autofocus placeholder="City" />
        <ValidationMessage For="@(() => Command.BillingAdress.City)" />

        <label for="inputPostCode" class="sr-only">PostCode</label>
        <InputText id="inputPostCode" class="form-control" aria-required="true" @bind-Value="Command.BillingAdress.PostCode" autofocus placeholder="PostCode" />
        <ValidationMessage For="@(() => Command.BillingAdress.PostCode)" />
        <label class="text-danger">@error</label>

    </EditForm>
}




@if (ShoppingCartItems == null)
{
    <DisplaySpinner />
}
else
{
    <div class="container">
        <span class="discount-box">
            <EditForm Model="this" OnValidSubmit="HandleApplyDiscount">
                <div class="form-group">
                    <label for="discountCode">Discount Code:</label>
                    <InputText id="discountCode" @bind-Value="discountCode" class="form-control" />
                </div>
                <button type="submit" class="btn btn-primary">Apply Discount</button>
            </EditForm>
        </span>
    </div>

    <section class="container-fluid">
        <div class="col-md-6">
            <h4 class="mb-2">Payment Summary</h4>
            @if (ShoppingCartItems.Count() > 0)
            {
                <table class="table">
                    <thead>
                        <tr>
                            <th>Product</th>
                            <th>Price</th>
                        </tr>
                    </thead>
                    <tbody>
                        @foreach (var item in ShoppingCartItems)
                        {
                            <tr>
                                <td>@item.Quantity x @item.ProductName</td>
                                @if (item.Product!.DiscountedPrice > 0 || item.Product.DiscountedPrice != null)
                                {
                                    <td>@item.Product.DiscountedPrice.ToString()</td>
                                }
                                else
                                {
                                    <td>@item.TotalPrice.ToString("C")</td>
                                }
                                
                            </tr>
                        }
                        <tr>
                            <td><b>Total </b></td>
                            <td><b></b>@PaymentAmount.ToString("C")</td>
                        </tr>
                    </tbody>
                </table>
                <button class="btn btn-lg btn-primary btn-block" type="submit" @onclick="OnSubmit">Purchase</button>
            }
            else
            {
                <p>You currently have no items in your shopping cart</p>
            }
        </div>
    </section>
}

@code {
    [Inject]
    ICartOrderTransferService CartOrderTransferService { get; set; } = default!;

    [Inject]
    IUsersService userService { get; set; } = default!;

    [Inject]
    ICartItemsService CartItemService { get; set; } = default!;

    [Inject]
    IDiscountService DiscountService { get; set; } = default!;

    [Inject]
    private ICartsService CartsService { get; set; } = default!;

    [Inject]
    DiscountCodeState discountCodeState { get; set; } = default!;

    protected List<CartItemDto> ShoppingCartItems { get; set; } = default!;

    private ClaimsPrincipal User = default!;

    private UserDto UserInfo = default!;

    private CartDto cart = default!;

    [SupplyParameterFromForm]
    PlaceOrderCommand? Command { get; set; } = new();

    string? error { get; set; }

    public string discountCode = default!; 

    private int UserId;

    protected int TotalQuantity { get; set; } = default!;

    protected decimal PaymentAmount { get; set; }

    protected override async Task OnInitializedAsync()
    {
        try
        {
            await GetAuthenticatedUserCart();

            ShoppingCartItems = await CartItemService.GetCartItems(UserId);

            PaymentAmount = ShoppingCartItems.Sum(item =>
            {
                var priceToUse = item.Product!.DiscountedPrice.HasValue ? item.Product.DiscountedPrice.Value : item.Product.Price;

                return priceToUse * item.Quantity;
            });

            TotalQuantity = ShoppingCartItems.Sum(p => p.Quantity);

        }
        catch (Exception)
        {

            throw;
        }
    }

    protected void OnSubmit()
    {
        navigationManager.NavigateTo("/CheckoutSuccess");
    }

    protected async Task GetAuthenticatedUserCart()
    {
        var authState = await authenticationStateProvider.GetAuthenticationStateAsync();

        User = authState.User;

        if (!User.Identity!.IsAuthenticated)
        {
            navigationManager.NavigateTo("");
        }

        string userIdClaimValue = User.FindFirst(ClaimTypes.NameIdentifier)?.Value!;
        if (int.TryParse(userIdClaimValue, out int userId))
        {
            UserId = userId;
        }

        if (User.Identity!.IsAuthenticated)
        {
            cart = await CartsService.GetCartByUser(UserId);
            UserInfo = await userService.GetUser(UserId);
        }
    }

    private List<CartItemDto> GetCartItems(int userId)
    { 

        var cartItems = ShoppingCartItems
        .Where(ci => ci.Id == cart.UserId)
        .ToList();

        return cartItems!;
    }

    private async Task HandleApplyDiscount()
    {
        if (!string.IsNullOrWhiteSpace(discountCode))
        {
            var result = await DiscountService.ApplyDiscount(UserId, discountCode);

            if (result)
            {
                var discount = await DiscountService.GetDiscount(discountCode);

                discountCodeState.DiscountCode = discount.DiscountCode!;

                PaymentAmount = PaymentAmount * discount.DiscountPercentage;

                Console.WriteLine("Discount applied successfully.");
                StateHasChanged();
            }
            else
            {
                Console.WriteLine("Failed to apply discount.");
                // show an error message to the user
            }
        }
    }

    private void CartChanged()
    {
        CartItemService.RaiseEventOnShoppingCartChanged(TotalQuantity);
    }
}
