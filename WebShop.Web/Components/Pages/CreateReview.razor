<button type="button" class="btn btn-info" data-bs-toggle="modal" data-bs-target="#addReviewModal">
    Add Review
</button>

<div class="modal fade" id="addReviewModal" tabindex="-1" aria-labelledby="addReviewModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="addReviewModalLabel">Add a Review for @Product?.Name</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <EditForm Model="newReview" OnValidSubmit="HandleReviewSubmit">
                    <div class="form-group">
                        <label for="reviewTitle">Title</label>
                        <InputTextArea id="reviewTitle" class="form-control" @bind-Value="newReview.Title" />
                    </div>
                    <div class="form-group">
                        <label for="reviewContent">Content</label>
                        <InputTextArea id="reviewContent" class="form-control" @bind-Value="newReview.Content" />
                    </div>
                    <button type="submit" class="btn btn-primary">Submit Review</button>
                </EditForm>
            </div>
        </div>
    </div>
</div>

@if (submitStatus != null)
{
    <div class="alert @alertClass" role="alert">
        @submitStatus
    </div>
}


@code {
    [Parameter]
    public int ProductId { get; set; }

    [Parameter]
    public int UserId { get; set; }

    [Parameter]
    public EventCallback OnReviewAdded { get; set; }

    [Inject]
    private IReviewServices ReviewService { get; set; } = default!;

    [Inject]
    private IProductsService ProductService { get; set; } = default!;

    private ProductDto Product { get; set; } = default!;

    private ReviewDto newReview = new ReviewDto();
    private string? submitStatus;
    private string? alertClass;

    protected override async Task OnInitializedAsync()
    {
        Product = await ProductService.GetProduct(ProductId);
    }

    private async Task HandleReviewSubmit()
    {
        newReview.ProductId = ProductId;
        newReview.UserId = UserId;
        var createdReview = await ReviewService.CreateReview(newReview);

        if (createdReview != null)
        {
            submitStatus = "Review added successfully!";
            alertClass = "alert-success";
            newReview = new ReviewDto();
            await OnReviewAdded.InvokeAsync();
        }
        else
        {
            submitStatus = "Failed to add review. Please try again.";
            alertClass = "alert-danger";
        }
    }
}